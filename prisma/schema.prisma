generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum StockStatus {
  IN_STOCK
  LISTED
  SOLD
  RETURNED
  WRITTEN_OFF
}

enum FulfillmentStatus {
  PENDING
  PACKED
  SHIPPED
  DELIVERED
  ISSUE
enum ListingStatus {
  ACTIVE
  PAUSED
  SOLD
  ENDED
}

model Location {
  id        String   @id @default(uuid())
  code      String   @unique
  type      String   @default("Box")
  notes     String?
  createdAt DateTime @default(now())

  stockUnits StockUnit[]
}

model Product {
  id        String   @id @default(uuid())
  title     String
  category  String?
  brand     String?
  notes     String?
  createdAt DateTime @default(now())

  stockUnits StockUnit[]
  watch      ProductWatch?
}

model ProductWatch {
  id             String   @id @default(uuid())
  productId      String   @unique
  active         Boolean  @default(true)
  targetBuyPrice Decimal?
  notes          String?
  priority       Int      @default(3)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Purchase {
  id             String   @id @default(uuid())
  purchaseDate   DateTime @default(now())
  vendor         String?
  totalExtraCost Decimal  @default(0)
  notes          String?
  createdAt      DateTime @default(now())

  stockUnits StockUnit[]
}

model StockUnit {
  id            String      @id @default(uuid())
  sku           String      @unique
  titleOverride String?
  condition     String?
  purchaseCost  Decimal     @default(0)
  extraCost     Decimal     @default(0)
  status        StockStatus @default(IN_STOCK)
  purchasedAt   DateTime    @default(now())
  notes         String?
  createdAt     DateTime    @default(now())

  // âœ… NEW FIELDS (for buying/selling online)
  purchasedFrom String?
  purchaseRef   String?
  purchaseUrl   String?
  brand         String?
  size          String?

  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  purchaseId String?
  purchase   Purchase? @relation(fields: [purchaseId], references: [id])

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  saleLine SaleLine?
  listings Listing[]

  archived   Boolean   @default(false)
  archivedAt DateTime?

  targetMarginPct   Decimal?
  recommendedPrice  Decimal?
  lastPricingEvalAt DateTime?
}

model Listing {
  id          String        @id @default(uuid())
  stockUnitId String
  platform    String
  listingId   String
  url         String?
  askPrice    Decimal       @default(0)
  status      ListingStatus @default(ACTIVE)
  listedAt    DateTime      @default(now())
  endedAt     DateTime?
  createdAt   DateTime      @default(now())

  stockUnit StockUnit @relation(fields: [stockUnitId], references: [id], onDelete: Cascade)

  @@index([stockUnitId])
  @@index([platform])
  @@unique([platform, listingId])
}

model Sale {
  id              String    @id @default(uuid())
  platform        String
  saleDate        DateTime  @default(now())
  orderRef        String?
  shippingCharged Decimal   @default(0)
  platformFees    Decimal   @default(0)
  shippingCost    Decimal   @default(0)
  otherCosts      Decimal   @default(0)
  notes           String?
  createdAt       DateTime  @default(now())
  archived        Boolean   @default(false)
  archivedAt      DateTime?
  fulfillmentStatus FulfillmentStatus @default(PENDING)
  trackingNumber  String?
  carrier         String?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  lines SaleLine[]
}

model SaleLine {
  id          String   @id @default(uuid())
  saleId      String
  stockUnitId String   @unique
  salePrice   Decimal  @default(0)
  createdAt   DateTime @default(now())

  sale      Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)
  stockUnit StockUnit @relation(fields: [stockUnitId], references: [id], onDelete: Restrict)
}
